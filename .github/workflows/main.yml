name: Sync IPTV Playlists

on:
  schedule:
    - cron: '0 */2 * * *'   # æ¯ 2 å°æ—¶è§¦å‘ï¼ˆUTCï¼‰
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    env:
      TOKEN: ${{ secrets.M3U_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Download and Update IPTV Playlists
        run: |
          set -e
          echo "ğŸµ å¼€å§‹ä¸‹è½½ IPTV æ’­æ”¾åˆ—è¡¨..."

          base="https://mursor.ottiptv.cc"
          files=("iptv.m3u" "yylunbo.m3u" "huyayqk.m3u" "douyuyqk.m3u")

          download_with_retry () {
            local url="$1"
            local outfile="$2"
            local attempt=1
            local max=5
            local ok=0

            while [ $attempt -le $max ]; do
              echo "â¡ï¸  [$attempt/$max] ä¸‹è½½ $outfile ..."
              if wget -q --timeout=15 --connect-timeout=10 "$url" -O "$outfile"; then
                echo "âœ… $outfile ä¸‹è½½æˆåŠŸ"
                ok=1
                break
              else
                echo "âš ï¸  $outfile ä¸‹è½½å¤±è´¥ï¼Œç­‰å¾… $attempt ç§’åé‡è¯•..."
                sleep $attempt
                attempt=$(( attempt + 1 ))
              fi
            done

            if [ $ok -eq 0 ]; then
              echo "âŒ $outfile æœ€ç»ˆä¸‹è½½å¤±è´¥"
              # æ¸…ç†ç©ºæ–‡ä»¶ï¼Œé¿å…è¯¯åˆ¤ä¸ºå˜æ›´
              rm -f "$outfile"
            fi
          }

          for f in "${files[@]}"; do
            download_with_retry "${base}/${f}?token=${TOKEN}" "$f"
          done

          echo "ğŸ“Š æ–‡ä»¶ä¸‹è½½çŠ¶æ€ï¼š"
          for f in "${files[@]}"; do
            if [ -s "$f" ]; then
              echo "âœ… $f - $(wc -c < "$f") å­—èŠ‚"
            else
              echo "âŒ $f - æœªæˆåŠŸä¸‹è½½"
            fi
          done

          git config --local user.name  "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet -- *.m3u; then
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi

          git add *.m3u
          git commit -m "chore: auto-update IPTV playlists - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "âœ… æ–‡ä»¶å·²æäº¤"

      - name: Push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push origin ${{ github.ref_name }}
          echo "ğŸš€ æ›´æ–°å·²æ¨é€åˆ°ä»“åº“"
