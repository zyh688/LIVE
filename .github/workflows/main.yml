name: Sync IPTV Playlists

on:
  schedule:
    - cron: '0 */2 * * *' 
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Download and Update IPTV Playlists
      run: |
        echo "ğŸµ å¼€å§‹ä¸‹è½½ IPTV æ’­æ”¾åˆ—è¡¨..."
        
        # ä¸‹è½½æ‰€æœ‰æ’­æ”¾åˆ—è¡¨æ–‡ä»¶
        wget https://mursor.ottiptv.cc/iptv.m3u -O iptv.m3u || echo "âŒ iptv.m3u ä¸‹è½½å¤±è´¥"
        wget https://mursor.ottiptv.cc/yylunbo.m3u -O yylunbo.m3u || echo "âŒ yylunbo.m3u ä¸‹è½½å¤±è´¥"
        wget https://mursor.ottiptv.cc/huyayqk.m3u -O huyayqk.m3u || echo "âŒ huyayqk.m3u ä¸‹è½½å¤±è´¥"
        wget https://mursor.ottiptv.cc/douyuyqk.m3u -O douyuyqk.m3u || echo "âŒ douyuyqk.m3u ä¸‹è½½å¤±è´¥"
        
        # æ£€æŸ¥ä¸‹è½½ç»“æœ
        echo "ğŸ“Š æ–‡ä»¶ä¸‹è½½çŠ¶æ€ï¼š"
        for file in iptv.m3u yylunbo.m3u huyayqk.m3u douyuyqk.m3u; do
          if [ -f "$file" ] && [ -s "$file" ]; then
            size=$(wc -c < "$file")
            echo "âœ… $file: ${size} å­—èŠ‚"
          else
            echo "âŒ $file: ä¸‹è½½å¤±è´¥æˆ–ä¸ºç©º"
          fi
        done
        
        # é…ç½® Git
        git config --local user.name "github-actions[bot]"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --quiet *.m3u 2>/dev/null; then
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
          exit 0
        fi
        
        # æ·»åŠ å¹¶æäº¤æ–‡ä»¶
        git add *.m3u
        git commit -m "chore: auto-update IPTV playlists - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "âœ… æ–‡ä»¶å·²æäº¤"
        
    - name: Push changes
      run: |
        git push origin ${{ github.ref_name }}
        echo "ğŸš€ æ›´æ–°å·²æ¨é€åˆ°ä»“åº“"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
